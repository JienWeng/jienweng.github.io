name: RSS to Buttondown
on:
  workflow_run:
    workflows: ["Deploy Zola to GitHub Pages"] # Adjust this to match your Zola deploy workflow name
    types: [completed]
  workflow_dispatch: 

jobs:
  newsletter:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install feedparser requests

      - name: Parse RSS and Create Buttondown Draft
        env:
          BD_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
          RSS_URL: "https://jienweng.github.io/rss.xml" # Update to your actual RSS URL
        run: |
          python - <<EOF
          import feedparser
          import requests
          import os

          # 1. Parse the feed
          feed = feedparser.parse(os.environ['RSS_URL'])
          if not feed.entries:
              print("No entries found.")
              exit(0)

          latest_post = feed.entries[0]
          title = latest_post.title
          link = latest_post.link
          # Zola usually puts the full content in 'description' or 'content'
          body = latest_post.get('content', [{'value': latest_post.description}])[0]['value']

          # 2. Prepare API call to Buttondown
          url = "https://api.buttondown.email/v1/emails"
          headers = {
              "Authorization": f"Token {os.environ['BD_API_KEY']}",
              "Content-Type": "application/json"
          }
          data = {
              "subject": title,
              "body": f"{body}\n\n<p><a href='{link}'>Read this post on the web</a></p>",
              "status": "draft" # Change to "sent" if you want it to go out automatically
          }

          # 3. Send to Buttondown
          response = requests.post(url, headers=headers, json=data)
          if response.status_code == 201:
              print(f"Successfully created draft: {title}")
          else:
              print(f"Error: {response.status_code} - {response.text}")
          EOF